name: Build iOS - Complete

on:
  workflow_dispatch:  # ÏàòÎèô Ïã§Ìñâ
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  # 1Îã®Í≥Ñ: ÏΩîÎìú Í≤ÄÏ¶ù Î∞è ÌÖåÏä§Ìä∏
  validate:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true
    
    - name: Verify Flutter installation
      run: |
        flutter --version
        flutter doctor -v
    
    - name: Get Flutter dependencies
      run: |
        echo "üì¶ Installing root dependencies..."
        flutter pub get
    
    - name: Get example dependencies
      run: |
        echo "üì¶ Installing example dependencies..."
        cd example
        flutter pub get
    
    - name: Analyze code
      run: |
        echo "üîç Analyzing code..."
        flutter analyze --no-fatal-infos
        cd example
        flutter analyze --no-fatal-infos
    
    - name: Run unit tests
      run: |
        echo "üß™ Running unit tests..."
        flutter test
        cd example
        flutter test
    
    - name: Check code formatting
      run: |
        echo "‚ú® Checking code formatting..."
        echo "Formatting root directory..."
        dart format lib/ test/ || true
        echo "Formatting example directory..."
        cd example
        dart format lib/ test/ || true
        cd ..
        echo "‚úÖ Code formatting check completed (auto-formatted if needed)"
    
    - name: Verify plugin structure
      run: |
        echo "üîç Verifying plugin structure..."
        echo "Checking plugin files..."
        [ -f "ios/Classes/DaouSampleAppPlugin.swift" ] || exit 1
        [ -f "ios/daou_sample_app.podspec" ] || exit 1
        [ -d "ios/Frameworks/SampleFramework.xcframework" ] || exit 1
        echo "‚úÖ Plugin structure verified"
    
    - name: Verify SampleFramework import
      run: |
        echo "üîç Verifying SampleFramework import..."
        if grep -q "import SampleFramework" ios/Classes/DaouSampleAppPlugin.swift; then
          echo "‚úÖ SampleFramework import found"
        else
          echo "‚ùå SampleFramework import not found!"
          exit 1
        fi

  # 2Îã®Í≥Ñ: iOS ÎπåÎìú
  build-ios:
    runs-on: macos-latest
    needs: validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'
    
    - name: Verify Flutter installation
      run: |
        echo "üîç Verifying Flutter installation..."
        flutter --version
        flutter doctor -v
    
    - name: Install CocoaPods
      run: |
        echo "üì¶ Installing CocoaPods..."
        sudo gem install cocoapods
        pod --version
    
    - name: Verify project structure
      run: |
        echo "üîç Verifying project structure..."
        echo "Current directory: $(pwd)"
        echo "Checking root pubspec.yaml..."
        [ -f "pubspec.yaml" ] || exit 1
        echo "Checking example directory..."
        [ -d "example" ] || exit 1
        echo "Checking iOS directory..."
        [ -d "example/ios" ] || exit 1
        echo "‚úÖ Project structure verified"
    
    - name: Verify SampleFramework exists
      run: |
        echo "üîç Verifying SampleFramework..."
        echo "Checking SampleFramework.xcframework..."
        ls -la ios/Frameworks/SampleFramework.xcframework/ || {
          echo "‚ùå SampleFramework.xcframework not found!"
          exit 1
        }
        echo "Checking SampleFrameworkSimul.xcframework..."
        ls -la ios/Frameworks/SampleFrameworkSimul.xcframework/ || {
          echo "‚ö†Ô∏è SampleFrameworkSimul.xcframework not found (optional)"
        }
        echo "Verifying plugin Swift file..."
        if grep -q "import SampleFramework" ios/Classes/DaouSampleAppPlugin.swift; then
          echo "‚úÖ SampleFramework import found"
        else
          echo "‚ùå SampleFramework import not found!"
          exit 1
        fi
    
    - name: Get Flutter dependencies
      run: |
        echo "üì¶ Installing root dependencies..."
        flutter pub get
    
    - name: Get example dependencies
      run: |
        echo "üì¶ Installing example dependencies..."
        cd example
        flutter pub get
        echo "‚úÖ Example dependencies installed"
    
    - name: Clean build directory
      run: |
        echo "üßπ Cleaning build directory..."
        cd example
        flutter clean
        rm -rf build/
        echo "‚úÖ Build directory cleaned"
    
    - name: Regenerate Flutter files (after clean)
      run: |
        echo "üîÑ Regenerating Flutter files after clean..."
        cd example
        flutter pub get
        echo "‚úÖ Flutter files regenerated"
    
    - name: Install iOS dependencies
      run: |
        echo "üì¶ Installing iOS dependencies (CocoaPods)..."
        cd example/ios
        # Generated.xcconfig ÌååÏùº ÌôïÏù∏
        if [ ! -f "../Flutter/Generated.xcconfig" ]; then
          echo "‚ùå Generated.xcconfig not found, running flutter pub get..."
          cd ..
          flutter pub get
          cd ios
        fi
        pod install --repo-update
        echo "‚úÖ CocoaPods dependencies installed"
        cd ../..
    
    - name: Verify Podfile setup
      run: |
        echo "üîç Verifying Podfile setup..."
        cd example/ios
        if [ -f "Podfile" ]; then
          echo "Podfile contents:"
          cat Podfile | head -20
        fi
        if [ -d "Pods" ]; then
          echo "‚úÖ Pods directory exists"
          ls -la Pods/ | head -10
        else
          echo "‚ùå Pods directory not found!"
          exit 1
        fi
        cd ../..
    
    - name: Configure code signing (disable)
      run: |
        echo "üîß Configuring code signing (disabling)..."
        cd example/ios
        
        # Xcode ÌîÑÎ°úÏ†ùÌä∏ÏóêÏÑú ÏÑúÎ™Ö ÎπÑÌôúÏÑ±Ìôî
        if [[ "$OSTYPE" == "darwin"* ]]; then
          # macOS
          sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' Runner.xcodeproj/project.pbxproj || true
          sed -i '' 's/DEVELOPMENT_TEAM = .*;/DEVELOPMENT_TEAM = "";/g' Runner.xcodeproj/project.pbxproj || true
          sed -i '' 's/"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]" = "iPhone Developer";/"CODE_SIGN_IDENTITY[sdk=iphoneos*]" = "";/g' Runner.xcodeproj/project.pbxproj || true
        else
          # Linux (fallback)
          sed -i 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' Runner.xcodeproj/project.pbxproj || true
          sed -i 's/DEVELOPMENT_TEAM = .*;/DEVELOPMENT_TEAM = "";/g' Runner.xcodeproj/project.pbxproj || true
          sed -i 's/"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]" = "iPhone Developer";/"CODE_SIGN_IDENTITY[sdk=iphoneos*]" = "";/g' Runner.xcodeproj/project.pbxproj || true
        fi
        
        echo "‚úÖ Code signing disabled"
        cd ../..
    
    - name: Build iOS App (Release, no codesign)
      run: |
        echo "üî® Building iOS app (Release, no codesign)..."
        cd example
        
        # Flutter ÎπåÎìú ÏãúÎèÑ
        echo "Attempting Flutter build..."
        flutter build ios --release --no-codesign || {
          echo "‚ö†Ô∏è Flutter build failed, trying xcodebuild directly..."
          cd ios
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphoneos \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -derivedDataPath ../build/ios \
            -allowProvisioningUpdates \
            -quiet || {
            echo "‚ùå xcodebuild failed"
            echo "Checking build logs..."
            xcodebuild -workspace Runner.xcworkspace \
              -scheme Runner \
              -configuration Release \
              -sdk iphoneos \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              -derivedDataPath ../build/ios \
              -allowProvisioningUpdates 2>&1 | tail -50
            exit 1
          }
          cd ..
        }
        
        echo "‚úÖ iOS build completed"
        cd ..
    
    - name: Verify build output
      run: |
        echo "üîç Verifying build output..."
        cd example
        
        # Ïó¨Îü¨ Í≤ΩÎ°úÏóêÏÑú .app Ï∞æÍ∏∞
        APP_PATH=""
        if [ -d "build/ios/iphoneos" ]; then
          APP_PATH=$(find build/ios/iphoneos -name "*.app" -type d 2>/dev/null | head -1)
        fi
        if [ -z "$APP_PATH" ] && [ -d "build/ios/Build/Products/Release-iphoneos" ]; then
          APP_PATH=$(find build/ios/Build/Products/Release-iphoneos -name "*.app" -type d 2>/dev/null | head -1)
        fi
        if [ -z "$APP_PATH" ]; then
          APP_PATH=$(find build/ios -name "*.app" -type d 2>/dev/null | head -1)
        fi
        
        if [ -n "$APP_PATH" ]; then
          echo "‚úÖ Found app at: $APP_PATH"
          APP_NAME=$(basename "$APP_PATH")
          echo "App name: $APP_NAME"
          
          # Ïã§Ìñâ ÌååÏùº Ïù¥Î¶Ñ (.app ÌôïÏû•Ïûê Ï†úÍ±∞)
          BINARY_NAME="${APP_NAME%.app}"
          echo "Binary name: $BINARY_NAME"
          
          # App Íµ¨Ï°∞ Í≤ÄÏ¶ù
          echo "Verifying app structure..."
          [ -f "$APP_PATH/Info.plist" ] || {
            echo "‚ùå Info.plist not found!"
            exit 1
          }
          [ -d "$APP_PATH/Frameworks" ] || echo "‚ö†Ô∏è Frameworks directory not found"
          
          # Ïã§Ìñâ ÌååÏùº Í≤ÄÏ¶ù (.app ÌôïÏû•Ïûê Ï†úÍ±∞Ìïú Ïù¥Î¶Ñ ÏÇ¨Ïö©)
          if [ -f "$APP_PATH/$BINARY_NAME" ]; then
            echo "‚úÖ App binary found: $APP_PATH/$BINARY_NAME"
          else
            echo "‚ö†Ô∏è App binary not found at expected path: $APP_PATH/$BINARY_NAME"
            echo "Listing app contents:"
            ls -la "$APP_PATH" || true
            echo "Searching for binary files:"
            find "$APP_PATH" -type f -perm +111 2>/dev/null | head -10 || true
            # Î∞îÏù¥ÎÑàÎ¶¨Í∞Ä ÏóÜÏñ¥ÎèÑ Í≥ÑÏÜç ÏßÑÌñâ (Í≤ΩÍ≥†Îßå ÌëúÏãú)
            echo "‚ö†Ô∏è Continuing despite missing binary..."
          fi
          
          # App Ï†ïÎ≥¥ Ï∂úÎ†•
          echo "App Info.plist contents:"
          plutil -p "$APP_PATH/Info.plist" | head -20 || true
          
          echo "App size:"
          du -sh "$APP_PATH"
          
          echo "‚úÖ App structure verified"
        else
          echo "‚ùå No .app file found!"
          echo "Build directory contents:"
          find build/ios -type f -name "*.app" -o -name "*.ipa" 2>/dev/null || true
          ls -la build/ios/ 2>/dev/null || true
          exit 1
        fi
        cd ..
    
    - name: Create IPA from App
      run: |
        echo "üì¶ Creating IPA from app..."
        cd example
        
        # .app ÌååÏùº Ï∞æÍ∏∞
        APP_PATH=""
        if [ -d "build/ios/iphoneos" ]; then
          APP_PATH=$(find build/ios/iphoneos -name "*.app" -type d 2>/dev/null | head -1)
        fi
        if [ -z "$APP_PATH" ] && [ -d "build/ios/Build/Products/Release-iphoneos" ]; then
          APP_PATH=$(find build/ios/Build/Products/Release-iphoneos -name "*.app" -type d 2>/dev/null | head -1)
        fi
        if [ -z "$APP_PATH" ]; then
          APP_PATH=$(find build/ios -name "*.app" -type d 2>/dev/null | head -1)
        fi
        
        if [ -z "$APP_PATH" ]; then
          echo "‚ùå No app found for IPA creation"
          exit 1
        fi
        
        APP_NAME=$(basename "$APP_PATH")
        echo "Creating IPA from: $APP_PATH"
        
        # IPA ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ± Î∞è Ï†ïÎ¶¨
        rm -rf build/ios/ipa
        mkdir -p build/ios/ipa/Payload
        
        # .app ÌååÏùºÏùÑ Payload Ìè¥ÎçîÎ°ú Î≥µÏÇ¨
        cp -R "$APP_PATH" build/ios/ipa/Payload/
        
        # Î≥µÏÇ¨ ÌôïÏù∏
        if [ ! -f "build/ios/ipa/Payload/$APP_NAME/Info.plist" ]; then
          echo "‚ùå Failed to copy app to Payload"
          exit 1
        fi
        
        # IPA ÌååÏùº ÏÉùÏÑ±
        cd build/ios/ipa
        zip -r "${APP_NAME%.app}.ipa" Payload -x "*.DS_Store" "*.git*" "*.swp" "*.swo" -q
        
        # IPA Í≤ÄÏ¶ù
        if [ ! -f "${APP_NAME%.app}.ipa" ]; then
          echo "‚ùå IPA file not created"
          exit 1
        fi
        
        echo "‚úÖ IPA created: ${APP_NAME%.app}.ipa"
        echo "IPA size:"
        ls -lh "${APP_NAME%.app}.ipa"
        
        # IPA Íµ¨Ï°∞ Í≤ÄÏ¶ù
        echo "Verifying IPA structure..."
        unzip -l "${APP_NAME%.app}.ipa" | grep -E "(Payload|Info.plist)" | head -5
        
        cd ../../..
    
    - name: Build iOS IPA (with codesign if credentials available)
      env:
        APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        APPLE_PROVISIONING_PROFILE: ${{ secrets.APPLE_PROVISIONING_PROFILE }}
      run: |
        echo "üîê Building iOS IPA with codesign (if credentials available)..."
        
        # Ïù∏Ï¶ùÏÑúÍ∞Ä ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏
        if [ -z "$APPLE_CERTIFICATE" ]; then
          echo "‚ÑπÔ∏è Apple certificate not found, skipping codesigned build"
          exit 0
        fi
        
        echo "‚úÖ Apple certificate found, proceeding with codesigned build..."
        
        cd example/ios
        
        # Ïù∏Ï¶ùÏÑú Î∞è ÌîÑÎ°úÎπÑÏ†ÄÎãù ÌîÑÎ°úÌååÏùº ÏÑ§Ï†ï
        echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12
        security create-keychain -p "" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain
        
        echo "$APPLE_PROVISIONING_PROFILE" | base64 --decode > profile.mobileprovision
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
        
        cd ../..
        cd example
        flutter build ipa --release
        echo "‚úÖ IPA build (with codesign) completed"
        ls -lh build/ios/ipa/*.ipa 2>/dev/null || echo "No IPA files found"
        cd ..
    
    - name: Verify all build outputs
      run: |
        echo "üîç Verifying all build outputs..."
        cd example
        
        echo "=== IPA Files ==="
        find build/ios -name "*.ipa" -type f -exec ls -lh {} \; || echo "No IPA files found"
        
        echo "=== App Files ==="
        find build/ios -name "*.app" -type d -exec du -sh {} \; || echo "No .app files found"
        
        echo "=== Build Summary ==="
        if [ -d "build/ios/ipa" ]; then
          echo "IPA directory:"
          ls -lh build/ios/ipa/ || true
        fi
        
        echo "‚úÖ Build verification completed"
        cd ..
    
    - name: Build summary
      run: |
        echo "üìä Build Summary"
        echo "================"
        cd example
        
        # IPA ÌååÏùº Ï∞æÍ∏∞
        IPA_COUNT=$(find build/ios -name "*.ipa" -type f 2>/dev/null | wc -l | tr -d ' ')
        APP_COUNT=$(find build/ios -name "*.app" -type d 2>/dev/null | wc -l | tr -d ' ')
        
        echo "IPA files: $IPA_COUNT"
        echo "App files: $APP_COUNT"
        
        if [ "$IPA_COUNT" -gt 0 ]; then
          echo "‚úÖ Build successful - IPA files created"
          find build/ios -name "*.ipa" -type f -exec echo "  - {}" \;
        elif [ "$APP_COUNT" -gt 0 ]; then
          echo "‚ö†Ô∏è Build partially successful - App files created but no IPA"
          find build/ios -name "*.app" -type d -exec echo "  - {}" \;
        else
          echo "‚ùå Build failed - No output files found"
          exit 1
        fi
        
        cd ..
    
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: ios-ipa
        path: example/build/ios/ipa/*.ipa
        retention-days: 30
        if-no-files-found: error
    
    - name: Upload App artifact (if IPA not found)
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: ios-app
        path: |
          example/build/ios/iphoneos/*.app
          example/build/ios/Build/Products/Release-iphoneos/*.app
        retention-days: 30
        if-no-files-found: warn
    
    - name: Upload build logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-logs
        path: |
          example/build/ios/**/*.log
        retention-days: 7
        if-no-files-found: ignore
